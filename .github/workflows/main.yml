name: secure-rdp

on: 
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest

    steps:
      - name: Set up job
        run: echo "Starting Secure RDP Setup..."

      - name: Configure Core RDP Settings
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Create RDP User with Permanent Password
        run: |
          $password = "Bullet@12345" | ConvertTo-SecureString -AsPlainText -Force
          New-LocalUser -Name "RDPUser" -Password $password -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDPUser"

      - name: Install Tailscale
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          iwr https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile ts.exe
          Start-Process .\ts.exe -ArgumentList "/quiet" -Wait

      - name: Establish Tailscale Connection
        run: |
          ts.exe up --authkey=${{ secrets.TS_KEY }} --hostname="github-rdp"

      - name: Verify RDP Accessibility
        run: |
          ts status

      - name: Maintain Connection
        run: |
          ping 127.0.0.1 -t

      - name: Complete job
        run: echo "RDP Setup Complete!"
